<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>A-Frame Maze</title>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
<a-scene>

  <!-- アセット読み込み -->
  <a-assets>
    <a-asset-item id="cork" src="cork_debag.glb"></a-asset-item>
    <a-asset-item id="kabe2" src="kabe_debag.glb"></a-asset-item>
    <a-asset-item id="yuka" src="yuka_debag.glb"></a-asset-item>
    <a-asset-item id="nikumaru" src="https://rawcdn.githack.com/etiennepinchon/aframe-fonts/gh-pages/fonts/nikumaru-msdf.json"></a-asset-item>
  </a-assets>

  <!-- プレイヤーリグ -->
  <a-entity id="rig" movement-controls position="2 1.6 2">
    <a-entity camera look-controls cork-shooter position="0 0 0">
      <!-- 十字線 -->
      <a-entity id="crosshair"
                geometry="primitive: ring; radiusInner: 0.002; radiusOuter: 0.004"
                material="color: red; shader: flat"
                position="0 0 -1">
      </a-entity>
    </a-entity>
  </a-entity>

  <!-- 迷路配置先 -->
  <a-entity id="maze"></a-entity>

</a-scene>

<script type="module">
// CorkFromTheEye.js を読み込む
import './CorkFromTheEye.js';

// movement-controls（簡易版）
AFRAME.registerComponent('movement-controls', {
  init: function () {
    this.velocity = new THREE.Vector3();
    this.direction = new THREE.Vector3();
    this.speed = 0.1;
    this.keys = {};
    window.addEventListener('keydown', (e) => { this.keys[e.code] = true; });
    window.addEventListener('keyup', (e) => { this.keys[e.code] = false; });
  },

  tick: function () {
    const el = this.el;
    const pos = el.getAttribute('position');
    const cam = el.querySelector('[camera]');
    const rot = cam.getAttribute('rotation');
    const angleY = THREE.MathUtils.degToRad(rot.y);

    this.direction.set(0, 0, 0);
    if (this.keys['KeyW'] || this.keys['ArrowUp']) { this.direction.x -= Math.sin(angleY); this.direction.z -= Math.cos(angleY); }
    if (this.keys['KeyS'] || this.keys['ArrowDown']) { this.direction.x += Math.sin(angleY); this.direction.z += Math.cos(angleY); }
    if (this.keys['KeyA'] || this.keys['ArrowLeft']) { this.direction.x -= Math.cos(angleY); this.direction.z += Math.sin(angleY); }
    if (this.keys['KeyD'] || this.keys['ArrowRight']) { this.direction.x += Math.cos(angleY); this.direction.z -= Math.sin(angleY); }

    if (this.direction.length() > 0) this.direction.normalize();
    this.velocity.copy(this.direction).multiplyScalar(this.speed);

    const newPos = { x: pos.x + this.velocity.x, y: pos.y + this.velocity.y, z: pos.z + this.velocity.z };
    if (!this.checkWallCollision(newPos)) el.setAttribute('position', newPos);
  },

  checkWallCollision: function(pos) {
    const walls = document.querySelectorAll('.wall-collision');
    const playerRadius = 0.3;
    for (let wall of walls) {
      const wPos = wall.getAttribute('position');
      const dist = Math.sqrt(Math.pow(pos.x - wPos.x, 2) + Math.pow(pos.z - wPos.z, 2));
      if (dist < playerRadius + 1) return true;
    }
    return false;
  }
});

// 迷路生成（createKabe.js と floor.js をインポートして使用）
import { createKabe } from "./createKabe.js";
import { createFloors } from "./floor.js";

const mazeArray = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,0,1],
  [1,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1],
  [1,0,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1],
  [1,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1],
  [1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1],
  [1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1],
  [1,1,1,1,1,1,1,1,1,0,1,0,1,0,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,0,1],
  [1,0,1,1,1,1,1,1,1,0,1,0,1,0,1,0,1,1,1],
  [1,0,1,0,0,0,0,0,0,0,1,0,1,0,1,0,0,0,1],
  [1,0,1,0,1,1,1,1,1,0,1,1,1,0,1,1,1,0,1],
  [1,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,1],
  [1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1],
  [1,0,1,0,0,0,1,0,1,0,0,0,0,0,0,0,1,0,1],
  [1,0,1,1,1,0,1,0,1,1,1,0,1,0,1,0,1,0,1],
  [1,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const scene = document.querySelector("#maze");
createKabe(scene, mazeArray);
createFloors(scene, 19);

</script>
</body>
</html>
